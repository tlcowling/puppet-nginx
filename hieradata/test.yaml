---
# Configure package details
nginx::package::version: latest
nginx::package::release: mainline

# Define an nginx config
config:
  user: nginx
  worker_processes: 1
  worker_shutdown_timeout: 30s
  daemon: on
  thread_pools:
    bob:
      threads: 10
      max_queue: 10
    bob2:
      threads: 100
      max_queue: 1003
  lock_file: giblets.lock
  master_process: off
  pcre_jit: off


# define a http block
http:
  client_body_timeout: 10s
  open_file_cache:
    max: 1
    inactive: 20

# define an events block
events:
  worker_connections: 2024
  # debug_connection:
    # - localhost
    # - 127.0.0.1:3432

# define some standard gzip configs
gzip:
  extreme:
    gzip: true
    gzip_comp_level: 9
  low:
    gzip: true
    gzip_comp_level: 3
  nogzip:
    gzip: false

ssl:
  hardcore:
    ssl: on
    ssl_ciphers: HIGH:!aNULL:!MD5

servers:
  tom01:
    listen:
      host: localhost
      port: 1234
      options:
        - http2
        - default_server
        - ssl
        - rcvbuf: 234
        - sndbuf: 234
        - so_keepalive: on
    locations: 
      - tom01
  tom02:
    listen:
      host: localhost
      port: 1235
      options:
        - http2
        - ssl

# define a location blocks (for reference in a server for example)
locations:
  tom01:
    etag: true
    uri: /test
    limit_except:
      method: GET
      allow:
        - 1.2.1.3
      deny:
        - all
    alias: bob
    max_ranges: 1
    internal: true
    access_control_lists:
      - deny_evil_corp

# Define upstreams that can be referred to later on
upstreams:
  webapp02: 
    method: least_conn
    servers: 
      - address: localhost:12345
        weight: 5
        max_conns: 3
        max_fails: 2
        fail_timeout: 30s
      - address: localhost:12346
  webapp01:
    servers:
      - address: localhost:1552
      - address: localhost:1551
      - address: localhost:1550

# Define streams and tell them which upstreams to point to
streams:
  test_balancer:
    protocol: tcp
    port: 12345
    upstream: webapp01
    access_control_lists:
      - allow_tcow_net
      - allow_mega_corp
  test_balancer2: 
    protocol: tcp
    port: 10987
    upstream: webapp01
    access_control_lists:
      - deny_evil_corp

auth_requests:
  tomtest:
    auth_request: /auth
    auth_request_set:
      test: giblets
      giblets: fresh

# Define a set of access_control_lists that can be assigned to
# streams.
access_control_lists:
  allow_tcow_net:
    allow:
      - 54.3.4.2
      - 1.2.3.4
      - 32.4.3.2
    deny:
      - all
  deny_evil_corp:
    deny:
      - 4.5.3.1
      - 3.2.5.6
  allow_mega_corp:
    allow:
      - 1.3.6.3
      - 2.3.4.5
